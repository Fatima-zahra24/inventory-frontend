<div class="dashboard">
  <header class="header">
    <div>
      <h1>Dashboard</h1>
      <p class="subtitle">Vue d'ensemble de votre inventaire</p>
    </div>
    <div class="header-date">
      {{ today | date:'EEEE d MMMM yyyy':'':'fr' }}
    </div>
  </header>

  <!-- Statistiques principales -->
  <div class="stats-grid" *appIsAdmin>
    <div class="stat-card">
      <div class="stat-icon products">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
        </svg>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ stats()?.totalProducts ?? totalProducts() }}</span>
        <span class="stat-label">Produits</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon warehouses">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4z"/>
        </svg>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ stats()?.totalWarehouses ?? totalWarehouses() }}</span>
        <span class="stat-label">Entrepots</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon quantity">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
        </svg>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ stats()?.totalQuantity ?? 0 | number }}</span>
        <span class="stat-label">Unite en stock</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon orders">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
          <rect x="9" y="3" width="6" height="4" rx="2"/>
          <path d="M9 14l2 2 4-4"/>
        </svg>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ orderStats()?.totalOrders ?? 0 }}</span>
        <span class="stat-label">Commandes</span>
      </div>
    </div>
  </div>

  <!-- Graphique des ventes -->
  <div class="chart-section" *appIsAdmin>
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <h2>Ventes des 7 derniers jours</h2>
          <p class="chart-subtitle">Evolution du chiffre d'affaires</p>
        </div>
        <div class="chart-total">
          <span class="total-value">{{ totalSalesLast7Days() | number:'1.2-2' }} DH</span>
          <span class="total-label">Total periode</span>
        </div>
      </div>
      <div class="chart-container">
        <canvas baseChart
          [data]="salesChartData"
          [options]="salesChartOptions"
          [type]="'bar'">
        </canvas>
      </div>
    </div>
  </div>

  <!-- Alertes de stock -->
  @if (alerts().length > 0) {
    <div class="alerts-section" *appIsAdmin>
      <div class="section-header">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <h2>Alertes de stock</h2>
          <span class="alert-count">{{ alerts().length }}</span>
        </div>
        <a routerLink="/inventory" class="view-all">Voir tout</a>
      </div>
      <div class="alerts-grid">
        @for (alert of alertsLimited(); track alert.productId) {
          <div class="alert-card" [class]="getAlertSeverityClass(alert.severity)">
            <div class="alert-icon">
              @if (alert.alertType === 'LOW_STOCK') {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 9v4M12 17h.01"/>
                  <path d="M3 12a9 9 0 1018 0 9 9 0 00-18 0z"/>
                </svg>
              } @else if (alert.alertType === 'OUT_OF_STOCK') {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
              } @else {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                </svg>
              }
            </div>
            <div class="alert-content">
              <span class="alert-product">{{ alert.productName }}</span>
              <span class="alert-code">{{ alert.productCode }}</span>
              <span class="alert-message">{{ alert.message }}</span>
            </div>
            <div class="alert-quantity">
              <span class="qty-current">{{ alert.currentQuantity }}</span>
              <span class="qty-label">/ {{ alert.minThreshold }} min</span>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Indicateurs de stock -->
  <div class="stock-indicators" *appIsAdmin>
    <div class="indicator-card low-stock">
      <div class="indicator-value">{{ stats()?.lowStockProducts ?? lowStockCount() }}</div>
      <div class="indicator-label">Stock faible</div>
      <div class="indicator-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 9v4M12 17h.01"/>
          <path d="M3 12a9 9 0 1018 0 9 9 0 00-18 0z"/>
        </svg>
      </div>
    </div>
    <div class="indicator-card out-of-stock">
      <div class="indicator-value">{{ stats()?.outOfStockProducts ?? outOfStockProducts() }}</div>
      <div class="indicator-label">Rupture de stock</div>
      <div class="indicator-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
      </div>
    </div>
    <div class="indicator-card revenue">
      <div class="indicator-value">{{ orderStats()?.totalRevenue ?? 0 | number:'1.0-0' }}</div>
      <div class="indicator-label">Chiffre d'affaires (DH)</div>
      <div class="indicator-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
        </svg>
      </div>
    </div>
    <div class="indicator-card movements">
      <div class="indicator-value">{{ stats()?.totalMovements ?? totalMovements() }}</div>
      <div class="indicator-label">Mouvements</div>
      <div class="indicator-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 1l4 4-4 4"/>
          <path d="M3 11V9a4 4 0 014-4h14"/>
          <path d="M7 23l-4-4 4-4"/>
          <path d="M21 13v2a4 4 0 01-4 4H3"/>
        </svg>
      </div>
    </div>
  </div>

  <div class="content-grid">
    <!-- Actions rapides -->
    <div class="card">
      <div class="card-header">
        <h2>Actions rapides</h2>
      </div>
      <div class="card-body">
        <div class="quick-actions">
          <a routerLink="/orders/new" class="action-btn primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
              <rect x="9" y="3" width="6" height="4" rx="2"/>
              <line x1="12" y1="11" x2="12" y2="17"/>
              <line x1="9" y1="14" x2="15" y2="14"/>
            </svg>
            Nouvelle commande
          </a>
          <a routerLink="/products/new" class="action-btn secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Nouveau produit
          </a>
          <a routerLink="/inventory/movements" class="action-btn secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 1l4 4-4 4"/>
              <path d="M3 11V9a4 4 0 014-4h14"/>
              <path d="M7 23l-4-4 4-4"/>
              <path d="M21 13v2a4 4 0 01-4 4H3"/>
            </svg>
            Mouvements de stock
          </a>
          <a routerLink="/orders" class="action-btn secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
              <rect x="9" y="3" width="6" height="4" rx="2"/>
            </svg>
            Voir les commandes
          </a>
        </div>
      </div>
    </div>

    <!-- Dernieres commandes -->
    <div class="card">
      <div class="card-header">
        <h2>Dernieres commandes</h2>
        <a routerLink="/orders" class="view-all">Voir tout</a>
      </div>
      <div class="card-body">
        @if (orderLoading()) {
          <div class="loading">Chargement...</div>
        } @else if (recentOrders().length === 0) {
          <div class="empty">Aucune commande</div>
        } @else {
          <div class="recent-list">
            @for (order of recentOrders(); track order.id) {
              <div class="recent-item order-item">
                <div class="item-info">
                  <span class="item-name">{{ order.orderNumber }}</span>
                  <span class="item-code">{{ order.customerName }}</span>
                </div>
                <div class="order-amount">{{ order.totalAmount | number:'1.2-2' }} DH</div>
                <span class="item-status" [class]="order.status?.toLowerCase()">
                  {{ getOrderStatusLabel(order.status) }}
                </span>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Derniers mouvements -->
    <div class="card movements-card">
      <div class="card-header">
        <h2>Derniers mouvements</h2>
        <a routerLink="/inventory/movements" class="view-all">Voir tout</a>
      </div>
      <div class="card-body">
        @if (movementLoading()) {
          <div class="loading">Chargement...</div>
        } @else if (recentMovements().length === 0) {
          <div class="empty">Aucun mouvement</div>
        } @else {
          <div class="movements-list">
            @for (movement of recentMovements(); track movement.id) {
              <div class="movement-item">
                <div class="movement-type" [class]="getMovementTypeClass(movement.type)">
                  @if (isIncomingMovement(movement.type)) {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                  } @else {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 5v14M5 12l7 7 7-7"/>
                    </svg>
                  }
                </div>
                <div class="movement-info">
                  <span class="movement-product">{{ movement.productName }}</span>
                  <span class="movement-details">
                    {{ getMovementTypeLabel(movement.type) }} - {{ movement.warehouseName }}
                  </span>
                </div>
                <div class="movement-quantity" [class]="isIncomingMovement(movement.type) ? 'incoming' : 'outgoing'">
                  {{ isIncomingMovement(movement.type) ? '+' : '-' }}{{ movement.quantity }}
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>
